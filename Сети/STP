STP
Spanning Tree Protocol - протокол канального уровня
STP решает эту задачу, автоматически блокируя соединения
Основной задачей STP является устранение петель в топологии произвольной сети Ethernet
Стандарт IEEE 802.1D, существуют более совершенные варианты протокола

Что такое STP
• Основной задачей протокола STP является борьба с широковещательными штормами(Broadcast Storm), при которых вся сеть становится неработоспособной
• К шторму приводят кольца (петли) в сети на основе bridge, поскольку в заголовке пакетов Ethernet нет информации о времени жизни кадра, как, например, у пакетов IP

STP физическая топология
• (R) STP исключает возможность просмотра одних и тех же МАС-адресов на нескольких bridge портах путем отключения дополнительных портов до этого МАС-адреса
• Первым (R) STP будет выбирать Root Bridge на основе наименьшего идентификатора bridge
• Затем (R) STP будет использовать алгоритм поиска по ширине, принимая Root bridge в качестве отправной точки
• Если алгоритм достигает МАС-адреса в первый раз - он оставляет активный link
• Если алгоритм достигает МАС-адреса во второй раз - он отключает link

STP логическая топология
• Для определения Root Bridge, bridges обмениваются сообщениями BPDU

В общем, протокол STP использует два типа сообщений:
• BPDU (Bridge Protocol Data Unit) - содержит информацию о коммутаторах
• TC (Topology Change Notification) - уведомляет о изменении топологии.

Для того чтобы определить какие порты заблокировать, а какие будут передавать данные, STP выполняет следующее:
• Выбор корневого моста (Root Bridge)
• Определение корневых портов (Root Port)
• Определение выделенных портов (Designated Port)

Root Bridge алгоритм выбора
• Если коммутатор получает BPDU от коммутатора с меньшим Bridge ID, то он перестает анонсировать информацию о том, что он корневой и начинает передавать BPDU bridge с меньшим Bridge ID
• В итоге только один bridge останется root и будет передавать BPDU
Изначально Bridge ID состоял из двух полей:
• Priority - поле, которое позволяет административно влиять на выборы корневого коммутатора MAC-адрес - используется как уникальный идентификатор, который, в случае совпадения значений приоритетов, позволяет выбрать корневой коммутатор. Т.к. МАС-адреса уникальны, то и Bridge ID уникален

Root port
• Порт bridge, который имеет кратчайший путь к root brige, называется root port
• У любого не root bridge может быть только один root port
• Root port выбирается на основе меньшего Root Path Cost - это общее значение стоимости всех линков до Root Bridge
• Если стоимость интерфейсов до root bridge совпадает, то выбор root port происходит на основе меньшего Bridge ID коммутатора. Если и Bridge ID коммутаторов до корневого коммутатора совпадает, то тогда корневой порт выбирается на основе Port ID (Наименьший номер интерфейса - например ens3 меньше ens4)

Designated port
• Bridge в сегменте сети, имеющий наименьшее расстояние до корневого коммутатора, называется назначенным bridge
• Порт этого коммутатора, который подключен к рассматриваемому сегменту сети называется Disignated port
Так же как и Root port выбирается на основе:
• Меньшего Root Path Cost
• Меньшего Bridge ID
• Меньшего Port ID

Роли и состояния портов port
Роли портов:
• Root Port - корневой порт коммутатора
• Designated Port - назначенный порт сегмента
• Nondesignated Port - не назначенный порт сегмента
• Disabled Port - порт который находится в выключенном состоянии
Состояния портов:
• Blocking - блокирование
• Listening - прослушивание
• Learning - обучение
• Forwarding - пересылка

Роли портов RSTP и STP состояния портов port
• Disabled port - for looped ports - отключенный для замкнутых портов
• Root port - путь к root bridge
• Alternative port - backup root port (only in RSTP) - резервный путь к корневому порту
• Designated port - forwarding port - порт пересылки
• Backup port - backup designated port (only in RSTP) - резервный порт пересылки

Изменение топологии
• Коммутатор, который обнаружил изменения в топологии отправляет Topology Change Notification (TC) BPDU root bridge
• Bridge, на котором произошли изменения, отправляет TCN BPDU через свой root port. Отправка сообщения повторяется каждый hello interval (2 секунды) до тех пор, пока получение сообщения не будет подтверждено
• Следующий bridge, который получил TCN BPDU, отправляет назад подтверждение. Подтверждение отправляется в следующем Hello BPDU, которое будет отправлять bridge, выставлением флага Topology Change Acknowledgement (TCA)

• Далее bridge, у которых порт работает в роли DP для сегмента, повторяют первые два шага и отправляют TCN через свой root port и ждут подтверждения
• После того, как root bridge получил TCN BPDU, он отправляет несколько следующих Hello с флагом ТСА. Эти сообщения получают все bridge.
• При получении сообщения hello с флагом ТСА, bridge использует короткий таймер (Forward Delay time) для того чтобы обновить записи в таблице коммутации. Обновления выполняется из-за того, что после изменений в топологии STP в таблице коммутации могут храниться неправильные записи
• Если порт изменяет состояние с Blocking в Forwarding, то он должен пройти через два промежуточных состояния: Listening и Learning. Переход из Forwarding s Blocking может выполняться сразу

